import json
import time
import buttons
import dbworker
import smrequests
import emoji as e
import threading
import os
import traceback
import asyncio
import pymysql
import pymysql.cursors
from telebot.apihelper import ApiTelegramException
from datetime import datetime
from telebot import TeleBot
from telebot import asyncio_filters
from telebot.async_telebot import AsyncTeleBot
from telebot import types
from telebot.asyncio_storage import StateMemoryStorage
from telebot.asyncio_handler_backends import State, StatesGroup
from buttons import main_buttons

from smrequests import getConnectionLinks, getAmneziaConnectionFile, switchUserActivity, addUser
from dbworker import User

from dotenv import load_dotenv

load_dotenv()

CONFIG = {
    "admin_tg_id": [int(os.getenv("ADMIN_TG_ID_1")), int(os.getenv("ADMIN_TG_ID_2"))],
    "one_month_cost": float(os.getenv("ONE_MONTH_COST")),
    "trial_period": os.getenv("TRIAL_PERIOD"),
    "perc_1": float(os.getenv("PERC_1")),
    "perc_3": float(os.getenv("PERC_3")),
    "perc_6": float(os.getenv("PERC_6")),
    "perc_12": float(os.getenv("PERC_12")),
    "UTC_time": int(os.getenv("UTC_TIME")),
    "tg_token": os.getenv("TG_TOKEN"),
    "tg_shop_token": os.getenv("TG_SHOP_TOKEN"),
    "count_free_from_referrer": int(os.getenv("COUNT_FREE_FROM_REFERRER")),
    "bot_name": os.getenv("BOT_NAME"),
    "db_host": os.getenv("DB_HOST"),
    "db_name": os.getenv("DB_NAME"),
    "db_user": os.getenv("DB_USER"),
    "db_password": os.getenv("DB_PASSWORD"),
    "server_manager_url": os.getenv("SERVER_MANAGER_URL"),
    "server_manager_email": os.getenv("SERVER_MANAGER_EMAIL"),
    "server_manager_password": os.getenv("SERVER_MANAGER_PASSWORD"),
    "server_manager_api_token": os.getenv("SERVER_MANAGER_API_TOKEN"),
}

dbworker.CONFIG = CONFIG
buttons.CONFIG = CONFIG
smrequests.CONFIG = CONFIG

with open("texts.json", encoding="utf-8") as file_handler:
    text_mess = json.load(file_handler)
    texts_for_bot = text_mess

DBCONNECT = "data.sqlite"
BOTAPIKEY = CONFIG["tg_token"]

bot = AsyncTeleBot(CONFIG["tg_token"], state_storage=StateMemoryStorage())

DBHOST = CONFIG["db_host"]
DBUSER = CONFIG["db_name"]
DBPASSWORD = CONFIG["db_user"]
DBNAME = CONFIG["db_password"]


class MyStates(StatesGroup):
    findUserViaId = State()
    prepareUserForSendMessage = State()
    sendMessageToUser = State()
    sendMessageToAllUser = State()
    sendMessageToAmneziaUser = State()
    sendMessageToAllInactiveUser = State()
    findUsersByName = State()
    editUser = State()
    editUserResetTime = State()

    UserAddTimeDays = State()
    UserAddTimeHours = State()
    UserAddTimeMinutes = State()
    UserAddTimeApprove = State()

    AdminNewUser = State()


async def getTrialButtons():
    trialButtons = types.InlineKeyboardMarkup(row_width=1)
    trialButtons.add(
        types.InlineKeyboardButton(e.emojize(":mobile_phone: iOS (iPhone, iPad)"), callback_data="Init:iPhone"),
        types.InlineKeyboardButton(e.emojize(":mobile_phone: Android"), callback_data="Init:Android"),
        types.InlineKeyboardButton(e.emojize(":laptop: –ü–ö (Windows, MacOS)"), callback_data="Init:PC")
    )
    return trialButtons


async def sendPayMessage(chatId):
    Butt_payment = types.InlineKeyboardMarkup()

    if chatId in CONFIG["admin_tg_id"]:
        Butt_payment.add(
            types.InlineKeyboardButton(e.emojize(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã: {int(getCostBySale(100))} —Ä—É–±."),
                                       callback_data="BuyMonth:100"))
    Butt_payment.add(
        types.InlineKeyboardButton(e.emojize(f"1 –º–µ—Å—è—Ü: {int(getCostBySale(1))} —Ä—É–±."),
                                   callback_data="BuyMonth:1"))
    Butt_payment.add(
        types.InlineKeyboardButton(e.emojize(f"3 –º–µ—Å—è—Ü–∞: {int(getCostBySale(3))} —Ä—É–±. (-{getSale(3)}%)"),
                                   callback_data="BuyMonth:3"))
    Butt_payment.add(
        types.InlineKeyboardButton(e.emojize(f"6 –º–µ—Å—è—Ü–µ–≤: {int(getCostBySale(6))} —Ä—É–±. (-{getSale(6)}%)"),
                                   callback_data="BuyMonth:6"))
    Butt_payment.add(
        types.InlineKeyboardButton(e.emojize(f"1 –≥–æ–¥: {int(getCostBySale(12))} —Ä—É–±. (-{getSale(12)}%)"),
                                   callback_data="BuyMonth:12"))
    await bot.send_message(chatId,
                           "<b>–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –º–æ–∂–Ω–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–æ–π</b>\n\n–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å –Æ–ö–∞—Å—Å–∞\n–ú—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –∏ –Ω–µ –∏–º–µ–µ–º –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –∫–∞—Ä—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–ª—è –æ–ø–ª–∞—Ç—ã\n\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫—É:",
                           reply_markup=Butt_payment, parse_mode="HTML")


async def sendConfig(chatId):
    user_dat = await User.GetInfo(chatId)
    if user_dat.trial_subscription == False:
        trialButtons = await getTrialButtons()
        await bot.send_message(chat_id=chatId,
                               text=f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:",
                               parse_mode="HTML", reply_markup=trialButtons)
    else:
        await bot.send_message(chat_id=chatId, text="–î–ª—è —ç—Ç–æ–≥–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É",
                               reply_markup=await main_buttons(user_dat))
        await sendPayMessage(chatId)


async def sendConfigAndInstructions(chatId, device='iPhone', type='xui'):
    user_dat = await User.GetInfo(chatId)
    tgId = str(user_dat.tgid)

    if type == 'xui':
        connectionLinks = await getConnectionLinks(tgId)
        if connectionLinks['success']:
            data = connectionLinks['data']
            link = data['link']

            instructionIPhone = f"<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN DUCKS –Ω–∞ iOS</b>\n\r\n\r1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <a href='https://apps.apple.com/ru/app/amneziavpn/id1600529900'>AmneziaVPN –∏–∑ AppStore</a>\n\r2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –Ω–∏–∂–µ, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Amnezia VPN, –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É ¬´–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ¬ª (–Ω–∞–∂–∞–≤ –Ω–∞ +), –¥–∞–ª–µ–µ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–í—Å—Ç–∞–≤–∏—Ç—å\" \n\r3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≤—Å—Ç–∞–≤–∫—É, –¥–∞–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏—Ç–µ \"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å\"\n\r4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è\" –∏ –≤–∫–ª—é—á–∏—Ç–µ VPN –±–æ–ª—å—à–æ–π –∫—Ä—É–≥–ª–æ–π –∫–Ω–æ–ø–∫–æ–π.\n\r\n\r–ì–æ—Ç–æ–≤–æ! üéâ\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support"
            instructionAndroid = f"<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN DUCKS –Ω–∞ Android</b>\n\r\n\r1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <a href='https://play.google.com/store/apps/details/v2rayNG?id=com.v2ray.ang'>v2rayNG –∏–∑ Google Play</a>. –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç Google Play, –Ω–∞–ø–∏—à–∏—Ç–µ @vpnducks_support –∏ –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º —Ñ–∞–π–ª –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n\r2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –Ω–∏–∂–µ, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –≤ –ø–µ—Ä–≤–æ–º –ø—É–Ω–∫—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ v2rayNG, –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ‚ûï, –Ω–∞—Ö–æ–¥—è—â—É—é—Å—è –≤–≤–µ—Ä—Ö—É —Å–ø—Ä–∞–≤–∞, –∑–∞—Ç–µ–º \"–ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞\"\n\r3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ‚ñ∂Ô∏è –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞ –∏ –≤—ã–¥–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —Ç—Ä–µ–±—É–µ–º—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è\n\r\n\r–ì–æ—Ç–æ–≤–æ! üéâ\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support"
            instructionPC = f"<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN DUCKS –Ω–∞ PC (Windows, MacOS)</b>\n\r\n\r1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ <a href='https://github.com/hiddify/hiddify-next/releases/download/v2.5.7/Hiddify-Windows-Setup-x64.Msix'>Hiddify –¥–ª—è Windows</a> –∏–ª–∏ <a href='https://apps.apple.com/ru/app/foxray/id6448898396'>FoXray –¥–ª—è MacOS</a>\n\r2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É, –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—É—é –Ω–∏–∂–µ, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –≤ –ø–µ—Ä–≤–æ–º –ø—É–Ω–∫—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É\n\r\n\r–ì–æ—Ç–æ–≤–æ! üéâ\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support"
            if (device == "iPhone"):
                await bot.send_message(chat_id=user_dat.tgid, text=e.emojize(instructionIPhone), parse_mode="HTML",
                                       disable_web_page_preview=True,
                                       reply_markup=await main_buttons(user_dat, True))
            if (device == "Android"):
                await bot.send_message(chat_id=user_dat.tgid, text=e.emojize(instructionAndroid), parse_mode="HTML",
                                       disable_web_page_preview=True,
                                       reply_markup=await main_buttons(user_dat, True))
            if (device == "PC"):
                await bot.send_message(chat_id=user_dat.tgid, text=e.emojize(instructionPC), parse_mode="HTML",
                                       disable_web_page_preview=True,
                                       reply_markup=await main_buttons(user_dat, True))

            await bot.send_message(chat_id=user_dat.tgid, text=f"<blockquote>{link}</blockquote>", parse_mode="HTML",
                                   reply_markup=await main_buttons(user_dat, True))
        else:
            await bot.send_message(user_dat.tgid,
                                   f"–í—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –Ω–∞—à–µ–º—É –≤–ø–Ω.\n\r–ó–∞ –ø–æ–º–æ—â—å—é –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @vpnducks_support",
                                   reply_markup=await main_buttons(user_dat, True), parse_mode="HTML")
    elif type == 'amnezia':
        fileResponse = await getAmneziaConnectionFile(tgId)
        if fileResponse['success']:
            data = fileResponse['data']
            configFull = data['file']

            instructionIPhone = f"<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN DUCKS –Ω–∞ iOS</b>\n\r\n\r1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <a href='https://apps.apple.com/ru/app/amneziavpn/id1600529900'>AmneziaVPN –¥–ª—è iOS –∏–∑ AppStore</a>\n\r2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –≤—ã—à–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ vpnducks_{str(user_dat.tgid)}.conf\n\r3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É\n\r4. –ù–∞–π–¥–∏—Ç–µ AmneziaVPN —Å—Ä–µ–¥–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–µ–º—É\n\r5. –û—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ AmneziaVPN –∏ —Å–ø—Ä–æ—Å–∏—Ç –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, —Å–æ–≥–ª–∞—Å–∏—Ç–µ—Å—å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏\n\r6. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –±–æ–ª—å—à—É—é –∫—Ä—É–≥–ª—É—é –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ì–æ—Ç–æ–≤–æ\n\r\n\r<a href='https://t.me/vpnducks_video/4'>–í–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</a>\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support"
            instructionAndroid = f"<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN DUCKS –Ω–∞ Android</b>\n\r\n\r1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <a href='https://play.google.com/store/apps/details?id=org.amnezia.vpn'>AmneziaVPN –¥–ª—è Android –∏–∑ Google Play</a>\n\r2. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –≤—ã—à–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ vpnducks_{str(user_dat.tgid)}.conf —Å –ø–æ–º–æ—â—å—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è AmneziaVPN\n\r3. –û—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ AmneziaVPN, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è\n\r4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –±–æ–ª—å—à—É—é –∫—Ä—É–≥–ª—É—é –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —Å–º–∞—Ä—Ç—Ñ–æ–Ω—É —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ì–æ—Ç–æ–≤–æ\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support"
            instructionPC = f"<b>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ VPN DUCKS –Ω–∞ PC (Windows, MacOS)</b>\n\r\n\r1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ AmneziaVPN <a href='https://github.com/amnezia-vpn/amnezia-client/releases/download/4.7.0.0/AmneziaVPN_4.7.0.0_x64.exe'>–¥–ª—è Windows</a> –∏–ª–∏ <a href='https://github.com/amnezia-vpn/amnezia-client/releases/download/4.7.0.0/AmneziaVPN_4.7.0.0.dmg'>–¥–ª—è MacOS</a>\n\r2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É\n\r3.–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π –≤—ã—à–µ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ vpnducks_{str(user_dat.tgid)}.conf –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ AmneziaVPN\n\r4. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è\n\r5. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –±–æ–ª—å—à—É—é –∫—Ä—É–≥–ª—É—é –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ì–æ—Ç–æ–≤–æ\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support"
            if (device == "iPhone"):
                await bot.send_document(chat_id=user_dat.tgid, caption=e.emojize(instructionIPhone), parse_mode="HTML",
                                        reply_markup=await main_buttons(user_dat, True), document=configFull,
                                        visible_file_name=f"vpnducks_{str(user_dat.tgid)}.conf")
            if (device == "Android"):
                await bot.send_document(chat_id=user_dat.tgid, caption=e.emojize(instructionAndroid), parse_mode="HTML",
                                        reply_markup=await main_buttons(user_dat, True), document=configFull,
                                        visible_file_name=f"vpnducks_{str(user_dat.tgid)}.conf")
            if (device == "PC"):
                await bot.send_document(chat_id=user_dat.tgid, caption=e.emojize(instructionPC), parse_mode="HTML",
                                        reply_markup=await main_buttons(user_dat, True), document=configFull,
                                        visible_file_name=f"vpnducks_{str(user_dat.tgid)}.conf")
        else:
            await bot.send_message(user_dat.tgid,
                                   f"–í—ã –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –Ω–∞—à–µ–º—É –≤–ø–Ω.\n\r–ó–∞ –ø–æ–º–æ—â—å—é –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @vpnducks_support",
                                   reply_markup=await main_buttons(user_dat, True), parse_mode="HTML")


async def addTrialForReferrerByUserId(userId):
    user_dat = await User.GetInfo(userId)
    try:
        if user_dat.referrer_id and user_dat.referrer_id > 0:
            referrer_id = int(user_dat.referrer_id)
        else:
            referrer_id = 0
    except TypeError:
        referrer_id = 0

    if referrer_id != 0:
        user_dat_referrer = await User.GetInfo(user_dat.referrer_id)
        addTrialTime = 30 * CONFIG['count_free_from_referrer'] * 60 * 60 * 24

        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
        dbCur = conn.cursor(pymysql.cursors.DictCursor)
        dbCur.execute(
            f"Update userss set subscription=subscription+{addTrialTime}, banned=false where tgid={referrer_id}")
        conn.commit()
        dbCur.close()
        conn.close()

        await bot.send_message(user_dat.referrer_id,
                               f"<b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b>\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–∏—à–µ–¥—à–∏–π –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ, –æ–ø–ª–∞—Ç–∏–ª –ø–æ–¥–ø–∏—Å–∫—É, –≤–∞–º –¥–æ–±–∞–≤–ª–µ–Ω <b>+1 –º–µ—Å—è—Ü</b> –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞",
                               reply_markup=await main_buttons(user_dat_referrer, True), parse_mode="HTML")


@bot.message_handler(commands=['start'])
async def start(message: types.Message):
    if message.chat.type == "private":
        await bot.delete_state(message.from_user.id)
        user_dat = await User.GetInfo(message.chat.id)

        if user_dat.registered:
            await sendConfig(message.chat.id)
            await bot.send_message(message.chat.id, e.emojize("–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ :index_pointing_up:"),
                                   parse_mode="HTML",
                                   reply_markup=await main_buttons(user_dat))
        else:
            try:
                username = "@" + str(message.from_user.username)
            except:
                username = str(message.from_user.id)

            if (username == "@None"):
                username = str(message.from_user.id)

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º referrer_id
            arg_referrer_id = message.text[7:]
            referrer_id = None if arg_referrer_id is None else arg_referrer_id
            if not referrer_id:
                referrer_id = 0

            if user_dat.registered == False:
                addedStatus = await addUser(message.from_user.id, username)
                if addedStatus:
                    await user_dat.Adduser(message.from_user.id, username, message.from_user.full_name, referrer_id)
                else:
                    return

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
            if referrer_id and referrer_id != user_dat.tgid:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à–µ–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç—Ç–æ
                referrerUser = await User.GetInfo(referrer_id)
                await bot.send_message(referrer_id,
                                       f"–ü–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ –ø—Ä–∏—à–µ–ª –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å\n–í—ã –ø–æ–ª—É—á–∏—Ç–µ +1 –º–µ—Å—è—Ü –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞, –µ—Å–ª–∏ –æ–Ω –æ–ø–ª–∞—Ç–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É",
                                       reply_markup=await main_buttons(referrerUser))

            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä–µ—Ñ–µ—Ä–∞–ª–∞)
            user_dat = await User.GetInfo(message.chat.id)
            trialText = e.emojize(f"–ü—Ä–∏–≤–µ—Ç, {user_dat.fullname}!\n\r\n\r" \
                                  f"üéÅ <b>–î–∞—Ä–∏–º –≤–∞–º 7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!</b>\n\r\n\r" \
                                  f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ –ø–ª–∞–Ω—à–µ—Ç–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\n\r")

            trialButtons = await getTrialButtons()
            await bot.send_message(message.chat.id, trialText, parse_mode="HTML", reply_markup=trialButtons)


@bot.message_handler(state=MyStates.editUser, content_types=["text"])
async def Work_with_Message(m: types.Message):
    async with bot.retrieve_data(m.from_user.id) as data:
        tgid = data['usertgid']
    user_dat = await User.GetInfo(tgid)
    if e.demojize(m.text) == "–ù–∞–∑–∞–¥ :right_arrow_curving_left:":
        await bot.reset_data(m.from_user.id)
        await bot.delete_state(m.from_user.id)
        await bot.send_message(m.from_user.id, "–í–µ—Ä–Ω—É–ª –≤–∞—Å –Ω–∞–∑–∞–¥!", reply_markup=await buttons.admin_buttons())
        return
    if e.demojize(m.text) == "–î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º—è":
        await bot.set_state(m.from_user.id, MyStates.UserAddTimeDays)
        Butt_skip = types.ReplyKeyboardMarkup(resize_keyboard=True)
        Butt_skip.add(types.KeyboardButton(e.emojize(f"–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å :next_track_button:")))
        await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å:", reply_markup=Butt_skip)
        return
    if e.demojize(m.text) == "–û–±–Ω—É–ª–∏—Ç—å –≤—Ä–µ–º—è":
        await bot.set_state(m.from_user.id, MyStates.editUserResetTime)
        Butt_skip = types.ReplyKeyboardMarkup(resize_keyboard=True)
        Butt_skip.add(types.KeyboardButton(e.emojize(f"–î–∞")))
        Butt_skip.add(types.KeyboardButton(e.emojize(f"–ù–µ—Ç")))
        await bot.send_message(m.from_user.id, "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Ä–µ–º—è –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ?",
                               reply_markup=Butt_skip)
        return


@bot.message_handler(state=MyStates.editUserResetTime, content_types=["text"])
async def Work_with_Message(m: types.Message):
    async with bot.retrieve_data(m.from_user.id) as data:
        tgid = data['usertgid']

    if e.demojize(m.text) == "–î–∞":
        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
        dbCur = conn.cursor(pymysql.cursors.DictCursor)
        dbCur.execute(f"Update userss set subscription = %s, banned=false where tgid=%s",
                      (str(int(time.time())), tgid))
        conn.commit()
        dbCur.close()
        conn.close()

        await bot.send_message(m.from_user.id, "–í—Ä–µ–º—è —Å–±—Ä–æ—à–µ–Ω–æ!")

    async with bot.retrieve_data(m.from_user.id) as data:
        usertgid = data['usertgid']
    user_dat = await User.GetInfo(usertgid)
    readymes = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>{str(user_dat.fullname)}</b> ({str(user_dat.username)})\nTG-id: <code>{str(user_dat.tgid)}</code>\n\n"

    if int(user_dat.subscription) > int(time.time()):
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –¥–æ <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :check_mark_button:"
    else:
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :cross_mark:"
    await bot.set_state(m.from_user.id, MyStates.editUser)

    await bot.send_message(m.from_user.id, e.emojize(readymes),
                           reply_markup=await buttons.admin_buttons_edit_user(user_dat), parse_mode="HTML")


@bot.message_handler(state=MyStates.UserAddTimeDays, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å :next_track_button:":
        days = 0
    else:
        try:
            days = int(m.text)
        except:
            await bot.send_message(m.from_user.id, "–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ!\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return
        if days < 0:
            await bot.send_message(m.from_user.id, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return

    async with bot.retrieve_data(m.from_user.id) as data:
        data['days'] = days
    await bot.set_state(m.from_user.id, MyStates.UserAddTimeHours)
    Butt_skip = types.ReplyKeyboardMarkup(resize_keyboard=True)
    Butt_skip.add(types.KeyboardButton(e.emojize(f"–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å :next_track_button:")))
    await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å:", reply_markup=Butt_skip)


@bot.message_handler(state=MyStates.UserAddTimeHours, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å :next_track_button:":
        hours = 0
    else:
        try:
            hours = int(m.text)
        except:
            await bot.send_message(m.from_user.id, "–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ!\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return
        if hours < 0:
            await bot.send_message(m.from_user.id, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return

    async with bot.retrieve_data(m.from_user.id) as data:
        data['hours'] = hours
    await bot.set_state(m.from_user.id, MyStates.UserAddTimeMinutes)
    Butt_skip = types.ReplyKeyboardMarkup(resize_keyboard=True)
    Butt_skip.add(types.KeyboardButton(e.emojize(f"–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å :next_track_button:")))
    await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å:", reply_markup=Butt_skip)


@bot.message_handler(state=MyStates.UserAddTimeMinutes, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å :next_track_button:":
        minutes = 0
    else:
        try:
            minutes = int(m.text)
        except:
            await bot.send_message(m.from_user.id, "–î–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ!\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return
        if minutes < 0:
            await bot.send_message(m.from_user.id, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º!\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return

    async with bot.retrieve_data(m.from_user.id) as data:
        data['minutes'] = minutes
        hours = data['hours']
        days = data['days']
        tgid = data['usertgid']

    await bot.set_state(m.from_user.id, MyStates.UserAddTimeApprove)
    Butt_skip = types.ReplyKeyboardMarkup(resize_keyboard=True)
    Butt_skip.add(types.KeyboardButton(e.emojize(f"–î–∞")))
    Butt_skip.add(types.KeyboardButton(e.emojize(f"–ù–µ—Ç")))
    await bot.send_message(m.from_user.id,
                           f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {str(tgid)} –¥–æ–±–∞–≤–∏—Ç—Å—è:\n\n–î–Ω–∏: {str(days)}\n–ß–∞—Å—ã: {str(hours)}\n–ú–∏–Ω—É—Ç—ã: {str(minutes)}\n\n–í—Å–µ –≤–µ—Ä–Ω–æ ?",
                           reply_markup=Butt_skip)


@bot.message_handler(state=MyStates.UserAddTimeApprove, content_types=["text"])
async def Work_with_Message(m: types.Message):
    all_time = 0
    if e.demojize(m.text) == "–î–∞":
        async with bot.retrieve_data(m.from_user.id) as data:
            minutes = data['minutes']
            hours = data['hours']
            days = data['days']
            tgid = data['usertgid']
        all_time += minutes * 60
        all_time += hours * 60 * 60
        all_time += days * 60 * 60 * 24
        await AddTimeToUser(tgid, all_time)

        userDat = await User.GetInfo(tgid)
        await bot.send_message(chat_id=tgid,
                               text=f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!\n\n–ú—ã –¥–∞—Ä–∏–º –∫ –≤–∞—à–µ–π –ø–æ–¥–ø–∏—Å–∫–µ: {days} –¥–Ω–µ–π {hours} —á–∞—Å–æ–≤ {minutes} –º–∏–Ω—É—Ç",
                               reply_markup=await main_buttons(userDat))
        await bot.send_message(m.from_user.id, e.emojize("–í—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é!"), parse_mode="HTML")

    async with bot.retrieve_data(m.from_user.id) as data:
        usertgid = data['usertgid']
    user_dat = await User.GetInfo(usertgid)
    readymes = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>{str(user_dat.fullname)}</b> ({str(user_dat.username)})\nTG-id: <code>{str(user_dat.tgid)}</code>\n\n"

    if int(user_dat.subscription) > int(time.time()):
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –¥–æ <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :check_mark_button:"
    else:
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :cross_mark:"
    await bot.set_state(m.from_user.id, MyStates.editUser)

    await bot.send_message(m.from_user.id, e.emojize(readymes),
                           reply_markup=await buttons.admin_buttons_edit_user(user_dat), parse_mode="HTML")


@bot.message_handler(state=MyStates.findUserViaId, content_types=["text"])
async def Work_with_Message(m: types.Message):
    await bot.delete_state(m.from_user.id)
    try:
        user_id = int(m.text)
    except:
        await bot.send_message(m.from_user.id, "–ù–µ–≤–µ—Ä–Ω—ã–π Id!", reply_markup=await buttons.admin_buttons())
        return
    user_dat = await User.GetInfo(user_id)
    if not user_dat.registered:
        await bot.send_message(m.from_user.id, "–¢–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!",
                               reply_markup=await buttons.admin_buttons())
        return

    readymes = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>{str(user_dat.fullname)}</b> ({str(user_dat.username)})\nTG-id: <code>{str(user_dat.tgid)}</code>\n\n"

    if int(user_dat.subscription) > int(time.time()):
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –¥–æ <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :check_mark_button:"
    else:
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :cross_mark:"
    await bot.set_state(m.from_user.id, MyStates.editUser)
    async with bot.retrieve_data(m.from_user.id) as data:
        data['usertgid'] = user_dat.tgid
    await bot.send_message(m.from_user.id, e.emojize(readymes),
                           reply_markup=await buttons.admin_buttons_edit_user(user_dat), parse_mode="HTML")


@bot.message_handler(state=MyStates.prepareUserForSendMessage, content_types=["text"])
async def Work_with_Message(m: types.Message):
    await bot.delete_state(m.from_user.id)
    try:
        user_id = int(m.text)
    except:
        await bot.send_message(m.from_user.id, "–ù–µ–≤–µ—Ä–Ω—ã–π Id!", reply_markup=await buttons.admin_buttons())
        return
    user_dat = await User.GetInfo(user_id)
    if not user_dat.registered:
        await bot.send_message(m.from_user.id, "–¢–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!",
                               reply_markup=await buttons.admin_buttons())
        return

    readymes = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <b>{str(user_dat.fullname)}</b> ({str(user_dat.username)})\nTG-id: <code>{str(user_dat.tgid)}</code>\n\n"

    if int(user_dat.subscription) > int(time.time()):
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –¥–æ <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :check_mark_button:"
    else:
        readymes += f"–ü–æ–¥–ø–∏—Å–∫–∞: –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å <b>{datetime.utcfromtimestamp(int(user_dat.subscription) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}</b> :cross_mark:"
    await bot.set_state(m.from_user.id, MyStates.sendMessageToUser)
    async with bot.retrieve_data(m.from_user.id) as data:
        data['usertgid'] = user_dat.tgid
    await bot.send_message(m.from_user.id, e.emojize(readymes), parse_mode="HTML")
    await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", reply_markup=types.ReplyKeyboardRemove())


@bot.message_handler(state=MyStates.sendMessageToUser, content_types=["text"])
async def Work_with_Message(m: types.Message):
    async with bot.retrieve_data(m.from_user.id) as data:
        tgid = data['usertgid']
    await bot.send_message(tgid, e.emojize(m.text), parse_mode="HTML")
    await bot.delete_state(m.from_user.id)
    await bot.send_message(m.from_user.id, "–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", reply_markup=await buttons.admin_buttons())


@bot.message_handler(state=MyStates.sendMessageToAllUser, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ù–∞–∑–∞–¥ :right_arrow_curving_left:":
        await bot.delete_state(m.from_user.id)
        await bot.send_message(m.from_user.id, "–í–µ—Ä–Ω—É–ª –≤–∞—Å –Ω–∞–∑–∞–¥!", reply_markup=await buttons.admin_buttons())
        return

    user_dat = await User.GetInfo(m.from_user.id)
    allusers = await user_dat.GetAllUsers()

    for i in allusers:
        if i['banned'] == False:
            try:
                await bot.send_message(i['tgid'], e.emojize(m.text), parse_mode="HTML")
            except ApiTelegramException as exception:
                print("sendMessageToAllUser")
                print(exception.description)
                pass

    await bot.delete_state(m.from_user.id)
    await bot.send_message(m.from_user.id, "–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã", reply_markup=await buttons.admin_buttons())
    return


@bot.message_handler(state=MyStates.sendMessageToAmneziaUser, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ù–∞–∑–∞–¥ :right_arrow_curving_left:":
        await bot.delete_state(m.from_user.id)
        await bot.send_message(m.from_user.id, "–í–µ—Ä–Ω—É–ª –≤–∞—Å –Ω–∞–∑–∞–¥!", reply_markup=await buttons.admin_buttons())
        return

    user_dat = await User.GetInfo(m.from_user.id)
    allusers = await user_dat.GetAllUsers()

    for i in allusers:
        if i['banned'] == False and i['type'] == 'amnezia':
            try:
                await bot.send_message(i['tgid'], e.emojize(m.text), parse_mode="HTML")
            except ApiTelegramException as exception:
                print("sendMessageToAmneziaUser")
                print(exception.description)
                pass

    await bot.delete_state(m.from_user.id)
    await bot.send_message(m.from_user.id, "–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã", reply_markup=await buttons.admin_buttons())
    return


@bot.message_handler(state=MyStates.sendMessageToAllInactiveUser, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ù–∞–∑–∞–¥ :right_arrow_curving_left:":
        await bot.delete_state(m.from_user.id)
        await bot.send_message(m.from_user.id, "–í–µ—Ä–Ω—É–ª –≤–∞—Å –Ω–∞–∑–∞–¥!", reply_markup=await buttons.admin_buttons())
        return

    user_dat = await User.GetInfo(m.from_user.id)
    allusers = await user_dat.GetAllUsersWithoutSub()

    for i in allusers:
        try:
            await bot.send_message(i['tgid'], e.emojize(m.text), parse_mode="HTML")
        except ApiTelegramException as exception:
            print("sendMessageToAllInactiveUser")
            print(exception.description)
            pass

    await bot.delete_state(m.from_user.id)
    await bot.send_message(m.from_user.id, "–°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã", reply_markup=await buttons.admin_buttons())
    return


@bot.message_handler(state=MyStates.findUsersByName, content_types=["text"])
async def Work_with_Message(m: types.Message):
    if e.demojize(m.text) == "–ù–∞–∑–∞–¥ :right_arrow_curving_left:":
        await bot.delete_state(m.from_user.id)
        await bot.send_message(m.from_user.id, "–í–µ—Ä–Ω—É–ª –≤–∞—Å –Ω–∞–∑–∞–¥!", reply_markup=await buttons.admin_buttons())
        return

    user_dat = await User.GetInfo(m.from_user.id)
    allusers = await user_dat.GetAllUsers()
    for i in allusers:
        if i['username'] == m.text or i['username'] == '@' + m.text:
            try:
                await bot.send_message(m.from_user.id, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω:",
                                       reply_markup=await buttons.admin_buttons())
                await bot.send_message(m.from_user.id, f"{i['tgid']}", parse_mode="HTML")
                await bot.send_message(m.from_user.id, f"{i['username']}", parse_mode="HTML")
                await bot.send_message(m.from_user.id, f"{i['fullname']}", parse_mode="HTML")
                await bot.send_message(m.from_user.id, f"{datetime.utcfromtimestamp(int(i['subscription']) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}", parse_mode="HTML")
                await bot.delete_state(m.from_user.id)
                return
            except ApiTelegramException as exception:
                print("sendMessageToAllInactiveUser")
                print(exception.description)
                pass

    await bot.send_message(m.from_user.id, "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω:",
                           reply_markup=await buttons.admin_buttons())
    await bot.delete_state(m.from_user.id)
    return


@bot.message_handler(state="*", content_types=["text"])
async def Work_with_Message(m: types.Message):
    user_dat = await User.GetInfo(m.chat.id)

    if user_dat.registered == False:
        try:
            username = "@" + str(m.from_user.username)
        except:

            username = str(m.from_user.id)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º referrer_id
        arg_referrer_id = m.text[7:]
        referrer_id = arg_referrer_id if arg_referrer_id != user_dat.tgid else 0

        addedStatus = await addUser(m.chat.id, username)
        if addedStatus:
            await user_dat.Adduser(m.chat.id, username, m.from_user.full_name, referrer_id)

        await bot.send_message(m.chat.id,
                               texts_for_bot["hello_message"],
                               parse_mode="HTML", reply_markup=await main_buttons(user_dat))
        return
    await user_dat.CheckNewNickname(m)

    if e.demojize(m.text) == "–ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–∞—Å? :smiling_face_with_sunglasses:":
        await bot.send_message(m.chat.id, e.emojize(texts_for_bot["hello_message"]), parse_mode="HTML",
                               reply_markup=await main_buttons(user_dat))
        return

    if m.from_user.id in CONFIG["admin_tg_id"]:
        if e.demojize(m.text) == "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å :smiling_face_with_sunglasses:":
            await bot.send_message(m.from_user.id, "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å", reply_markup=await buttons.admin_buttons())
            return
        if e.demojize(m.text) == "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é :right_arrow_curving_left:":
            await bot.send_message(m.from_user.id, e.emojize("–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å :smiling_face_with_sunglasses:"),
                                   reply_markup=await main_buttons(user_dat))
            return
        if e.demojize(m.text) == "–í—ã–≤–µ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π :bust_in_silhouette:":
            await bot.send_message(m.from_user.id, e.emojize("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏."),
                                   reply_markup=await buttons.admin_buttons_output_users())
            return

        if e.demojize(m.text) == "–ù–∞–∑–∞–¥ :right_arrow_curving_left:":
            await bot.send_message(m.from_user.id, "–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å", reply_markup=await buttons.admin_buttons())
            return

        if e.demojize(m.text) == "–í—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π":
            allusers = await user_dat.GetAllUsers()
            readymass = []
            readymes = ""
            for i in allusers:
                if int(i['subscription']) > int(time.time()):
                    if len(readymes) + len(
                            f"{i['fullname']} ({i['username']}|{str(i['tgid'])}) :check_mark_button:\n") > 4090:
                        readymass.append(readymes)
                        readymes = ""
                    readymes += f"{i['fullname']} ({i['username']}|{str(i['tgid'])}) :check_mark_button:\n"
                else:
                    if len(readymes) + len(f"{i['fullname']} ({i['username']}|{str(i['tgid'])})\n") > 4090:
                        readymass.append(readymes)
                        readymes = ""
                    readymes += f"{i['fullname']} ({i['username']}|{str(i['tgid'])})\n"
            readymass.append(readymes)
            for i in readymass:
                await bot.send_message(m.from_user.id, e.emojize(i), reply_markup=await buttons.admin_buttons())
            return

        if e.demojize(m.text) == "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π":
            allusers = await user_dat.GetAllUsersWithSub()
            readymass = []
            readymes = ""
            if len(allusers) == 0:
                await bot.send_message(m.from_user.id, e.emojize("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π!"),
                                       reply_markup=await buttons.admin_buttons(), parse_mode="HTML")
                return
            for i in allusers:
                if int(i['subscription']) > int(time.time()):
                    if len(readymes) + len(
                            f"{i['fullname']} ({i['username']}|{str(i['tgid'])}) - {datetime.utcfromtimestamp(int(i['subscription']) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}\n") > 4090:
                        readymass.append(readymes)
                        readymes = ""
                    readymes += f"{i['fullname']} ({i['username']}|{str(i['tgid'])}) - {datetime.utcfromtimestamp(int(i['subscription']) + CONFIG['UTC_time'] * 3600).strftime('%d.%m.%Y %H:%M')}\n"
            readymass.append(readymes)
            for i in readymass:
                await bot.send_message(m.from_user.id, e.emojize(i))
            return

        if e.demojize(m.text) == "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ id":
            await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ Telegram Id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
                                   reply_markup=types.ReplyKeyboardRemove())
            await bot.set_state(m.from_user.id, MyStates.findUserViaId)
            return

        if e.demojize(m.text) == "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ :pencil:":
            await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ Telegram Id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
                                   reply_markup=types.ReplyKeyboardRemove())
            await bot.set_state(m.from_user.id, MyStates.prepareUserForSendMessage)
            return

        if e.demojize(m.text) == "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º :pencil:":
            await bot.set_state(m.from_user.id, MyStates.sendMessageToAllUser)
            await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
                                   reply_markup=await buttons.admin_buttons_back())
            return

        if e.demojize(m.text) == "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º Amnezia :pencil:":
            await bot.set_state(m.from_user.id, MyStates.sendMessageToAmneziaUser)
            await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
                                   reply_markup=await buttons.admin_buttons_back())
            return

        if e.demojize(m.text) == "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º :pencil:":
            await bot.set_state(m.from_user.id, MyStates.sendMessageToAllInactiveUser)
            await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
                                   reply_markup=await buttons.admin_buttons_back())
            return

        if e.demojize(m.text) == "–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫–Ω–µ–π–º—É :magnifying_glass_tilted_left:":
            await bot.set_state(m.from_user.id, MyStates.findUsersByName)
            await bot.send_message(m.from_user.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
                                   reply_markup=await buttons.admin_buttons_back())
            return

        if e.demojize(m.text) == "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è :plus:":
            await bot.send_message(m.from_user.id,
                                   "–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!\n–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ –∞—Ä–∞–±—Å–∫–∏–µ —Ü–∏—Ñ—Ä—ã.",
                                   reply_markup=await buttons.admin_buttons_back())
            await bot.set_state(m.from_user.id, MyStates.AdminNewUser)
            return

    if e.demojize(m.text) == "–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É :money_bag:":
        payment_info = await user_dat.PaymentInfo()
        if True:
            await sendPayMessage(m.chat.id)
        return

    if e.demojize(m.text) == "–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å :gear:":
        await sendConfig(m.chat.id)
        return

    if e.demojize(m.text) == "–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å :woman_and_man_holding_hands:":
        countReferal = await user_dat.countReferrerByUser()
        refLink = f"https://t.me/{CONFIG['bot_name']}?start=" + str(user_dat.tgid)

        msg = e.emojize(f"<b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\r\n\r" \
                        f":fire: –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, –ø—Ä–∏–≥–ª–∞—Å–∏–≤ –¥—Ä—É–∑–µ–π –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ. –û–Ω–∏ –ø–æ–ª—É—á–∞—Ç –Ω–µ–¥–µ–ª—é VPN –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∞ –µ—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ñ–æ—Ä–º—è—Ç –ø–æ–¥–ø–∏—Å–∫—É, –º—ã –ø–æ–¥–∞—Ä–∏–º –≤–∞–º –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ –º–µ—Å—è—Ü—É –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ DUCKS VPN!\n\r\n\r" \
                        f":money_bag: –ê –µ—Å–ª–∏ –≤—ã –±–ª–æ–≥–µ—Ä –∏–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –∫—Ä—É–ø–Ω–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–π –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—è –æ DUCKS VPN! –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support\n\r" \
                        f"\n\r–í–∞—à–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–µ–π, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å): \n\r<code>{refLink}</code>"
                        f"\n\r\n\r–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–∏—à–µ–¥—à–∏—Ö –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ: {str(countReferal)}")

        await bot.send_message(chat_id=m.chat.id, text=msg, parse_mode='HTML')
        return

    if e.demojize(m.text) == "–ü–æ–º–æ—â—å :heart_hands:":
        msg = e.emojize(f"–ö–∞–∫ –º—ã –º–æ–∂–µ–º –≤–∞–º –ø–æ–º–æ—á—å?")
        helpButtons = types.InlineKeyboardMarkup(row_width=1)
        helpButtons.add(
            types.InlineKeyboardButton(e.emojize(":credit_card: –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ"),
                                       callback_data="Help:update"),
            types.InlineKeyboardButton(e.emojize(":heart_hands: –ü–æ–¥–¥–µ—Ä–∂–∫–∞"), callback_data="Help:support"),
            types.InlineKeyboardButton(e.emojize(":repeat_button: –°–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª"), callback_data="Help:change_type"),
        )
        await bot.send_message(chat_id=m.chat.id, text=msg, parse_mode="HTML", reply_markup=helpButtons)
        return

    else:
        if "–ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å:" in m.text:
            await sendPayMessage(m.chat.id)
            return
        if "–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:" in m.text:
            return
        for admin in CONFIG["admin_tg_id"]:
            await bot.send_message(admin,
                                   f"–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç @{m.from_user.username} ({m.from_user.id}): {e.emojize(m.text)}")
        return


@bot.callback_query_handler(func=lambda c: 'Init:' in c.data)
async def Init(call: types.CallbackQuery):
    user_dat = await User.GetInfo(call.from_user.id)
    device = str(call.data).split(":")[1]
    await addUser(user_dat.tgid, user_dat.username)
    await sendConfigAndInstructions(user_dat.tgid, device, user_dat.type)
    await bot.answer_callback_query(call.id)


@bot.callback_query_handler(func=lambda c: 'Help:' in c.data)
async def Init(call: types.CallbackQuery):
    user_dat = await User.GetInfo(call.from_user.id)
    command = str(call.data).split(":")[1]
    if command == 'update':
        await bot.send_message(user_dat.tgid, e.emojize('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞'), parse_mode="HTML",
                               reply_markup=await main_buttons(user_dat, True))
    elif command == 'change_type':
        isTypeChanged = await user_dat.changeType()
        if isTypeChanged:
            await addUser(user_dat.tgid, user_dat.username)
            await bot.send_message(user_dat.tgid,
                                   e.emojize(
                                       '–ü—Ä–æ—Ç–æ–∫–æ–ª –∏–∑–º–µ–Ω–µ–Ω.\n–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å :gear:'),
                                   parse_mode="HTML",
                                   reply_markup=await main_buttons(user_dat, True))
    else:
        await bot.send_message(user_dat.tgid, e.emojize('–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support'), parse_mode="HTML",
                               reply_markup=await main_buttons(user_dat, True))

    await bot.answer_callback_query(call.id)


@bot.callback_query_handler(func=lambda c: 'Referrer' in c.data)
async def Referrer(call: types.CallbackQuery):
    user_dat = await User.GetInfo(call.from_user.id)
    countReferal = await user_dat.countReferrerByUser()
    refLink = f"https://t.me/{CONFIG['bot_name']}?start=" + str(user_dat.tgid)

    msg = e.emojize(f"<b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\r\n\r" \
                    f":fire: –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, –ø—Ä–∏–≥–ª–∞—Å–∏–≤ –¥—Ä—É–∑–µ–π –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ. –û–Ω–∏ –ø–æ–ª—É—á–∞—Ç –Ω–µ–¥–µ–ª—é VPN –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –∞ –µ—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ñ–æ—Ä–º—è—Ç –ø–æ–¥–ø–∏—Å–∫—É, –º—ã –ø–æ–¥–∞—Ä–∏–º –≤–∞–º –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ –º–µ—Å—è—Ü—É –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ DUCKS VPN!\n\r\n\r" \
                    f":money_bag: –ê –µ—Å–ª–∏ –≤—ã –±–ª–æ–≥–µ—Ä –∏–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –∫—Ä—É–ø–Ω–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–π –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—è –æ DUCKS VPN! –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support\n\r" \
                    f"\n\r–í–∞—à–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ (–∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –Ω–µ–π, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å): \n\r<code>{refLink}</code>"
                    f"\n\r\n\r–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–∏—à–µ–¥—à–∏—Ö –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ: {str(countReferal)}")

    await bot.send_message(chat_id=call.message.chat.id, text=msg, parse_mode='HTML')


@bot.callback_query_handler(func=lambda c: 'PayBlock' in c.data)
async def PayBlock(call: types.CallbackQuery):
    await sendPayMessage(call.message.chat.id)


@bot.callback_query_handler(func=lambda c: 'BuyMonth:' in c.data)
async def Buy_month(call: types.CallbackQuery):
    user_dat = await User.GetInfo(call.from_user.id)
    payment_info = await user_dat.PaymentInfo()

    Month_count = int(str(call.data).split(":")[1])
    await bot.delete_message(call.message.chat.id, call.message.id)

    bill = await bot.send_invoice(call.message.chat.id, f"–û–ø–ª–∞—Ç–∞ VPN", f"VPN –Ω–∞ {str(Month_count)} –º–µ—Å.", call.data,
                                  currency="RUB", prices=[
            types.LabeledPrice(f"VPN –Ω–∞ {str(Month_count)} –º–µ—Å.", getCostBySale(Month_count) * 100)],
                                  provider_token=CONFIG["tg_shop_token"])

    await bot.answer_callback_query(call.id)


async def AddTimeToUser(tgid, timetoadd):
    userdat = await User.GetInfo(tgid)

    if int(userdat.subscription) < int(time.time()):
        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
        dbCur = conn.cursor(pymysql.cursors.DictCursor)
        dbCur.execute(f"Update userss set subscription = %s, banned=false where tgid=%s",
                      (str(int(time.time()) + timetoadd), userdat.tgid))
        conn.commit()
        dbCur.close()
        conn.close()

        await switchUserActivity(str(userdat.tgid), True)

        await bot.send_message(userdat.tgid, e.emojize(
            '<b>–í–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞</b>\n\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∏ –∑–∞–Ω–æ–≤–æ –≤–∫–ª—é—á–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å vpn –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.\n\r\n\r–ß—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º @vpnducks_support'),
                               parse_mode="HTML", reply_markup=await main_buttons(userdat, True))
    else:
        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
        dbCur = conn.cursor(pymysql.cursors.DictCursor)
        dbCur.execute(f"Update userss set subscription = %s where tgid=%s",
                      (str(int(userdat.subscription) + timetoadd), userdat.tgid))
        conn.commit()
        dbCur.close()
        conn.close()

        await switchUserActivity(str(userdat.tgid), True)
        await bot.send_message(userdat.tgid, e.emojize(
            '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞'), parse_mode="HTML", reply_markup=await main_buttons(userdat, True))


@bot.pre_checkout_query_handler(func=lambda query: True)
async def checkout(pre_checkout_query):
    # (pre_checkout_query)
    month = int(str(pre_checkout_query.invoice_payload).split(":")[1])

    if getCostBySale(month) * 100 != pre_checkout_query.total_amount:
        await bot.answer_pre_checkout_query(pre_checkout_query.id, ok=False,
                                            error_message="–ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å –ø–æ —Å—Ç–∞—Ä–æ–π —Ü–µ–Ω–µ!")
        await bot.send_message(pre_checkout_query.from_user.id,
                               "<b>–¶–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å! –ù–µ–ª—å–∑—è –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –ø–æ —Å—Ç–∞—Ä–æ–π —Ü–µ–Ω–µ!</b>", parse_mode="HTML")
    else:
        await bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True,
                                            error_message="–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!")


def getCostBySale(month):
    cost = month * CONFIG['one_month_cost']
    oneMonthCost = float(CONFIG['one_month_cost'])
    perc3 = float(CONFIG['perc_3'])
    perc6 = float(CONFIG['perc_6'])
    perc12 = float(CONFIG['perc_12'])

    if month == 3:
        cost = oneMonthCost * perc3
    elif month == 6:
        cost = oneMonthCost * perc6
    elif month == 12:
        cost = oneMonthCost * perc12
    elif month == 100:
        cost = 60

    return int(cost)


def getSale(month):
    cost = month * CONFIG['one_month_cost']
    oneMonthCost = float(CONFIG['one_month_cost'])
    perc3 = float(CONFIG['perc_3'])
    perc6 = float(CONFIG['perc_6'])
    perc12 = float(CONFIG['perc_12'])

    if month == 3:
        sale = 100 - round((oneMonthCost * perc3 * 100) / cost)
    elif month == 6:
        sale = 100 - round((oneMonthCost * perc6 * 100) / cost)
    elif month == 12:
        sale = 100 - round((oneMonthCost * perc12 * 100) / cost)
    else:
        sale = 0
    return sale


@bot.message_handler(content_types=['successful_payment'])
async def got_payment(m):
    payment: types.SuccessfulPayment = m.successful_payment
    month = int(str(payment.invoice_payload).split(":")[1])

    user_dat = await User.GetInfo(m.from_user.id)
    await bot.send_message(m.from_user.id, e.emojize(texts_for_bot["success_pay_message"]),
                           reply_markup=await buttons.main_buttons(user_dat, True), parse_mode="HTML")

    addTimeSubscribe = month * 30 * 24 * 60 * 60
    await AddTimeToUser(m.from_user.id, addTimeSubscribe)

    payment_id = str(payment.provider_payment_charge_id)
    # save info about user
    await user_dat.NewPay(
        payment_id,
        getCostBySale(month),
        addTimeSubscribe,
        m.from_user.id)

    await addTrialForReferrerByUserId(m.from_user.id)

    for admin in CONFIG["admin_tg_id"]:
        await bot.send_message(admin,
                               f"–ù–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç @{m.from_user.username} ( {m.from_user.id} ) –Ω–∞ <b>{month}</b> –º–µ—Å. : {getCostBySale(month)} —Ä—É–±.",
                               parse_mode="HTML")


bot.add_custom_filter(asyncio_filters.StateFilter(bot))


def checkTime():
    global e
    while True:
        try:
            time.sleep(15)

            conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
            dbCur = conn.cursor(pymysql.cursors.DictCursor)
            dbCur.execute(f"SELECT * FROM userss WHERE blocked=false")
            log = dbCur.fetchall()
            dbCur.close()
            conn.close()

            for i in log:
                try:
                    time_now = int(time.time())
                    remained_time = int(i['subscription']) - time_now
                    if remained_time <= 0 and i['banned'] == False:
                        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
                        dbCur = conn.cursor(pymysql.cursors.DictCursor)
                        dbCur.execute(f"UPDATE userss SET banned=true where tgid=%s", (i['tgid'],))
                        conn.commit()
                        dbCur.close()
                        conn.close()

                        asyncio.run(switchUserActivity(str(i['tgid']), False))

                        dateto = datetime.utcfromtimestamp(int(i['subscription']) + CONFIG['UTC_time'] * 3600).strftime(
                            '%d.%m.%Y %H:%M')
                        Butt_main = types.ReplyKeyboardMarkup(resize_keyboard=True)
                        Butt_main.add(
                            types.KeyboardButton(e.emojize(f":red_circle: –ü–æ–¥–ø–∏—Å–∫–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å: {dateto} –ú–°–ö")))
                        Butt_main.add(types.KeyboardButton(e.emojize(f"–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É :money_bag:")),
                                      types.KeyboardButton(e.emojize(f"–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å :gear:")))
                        Butt_main.add(
                            types.KeyboardButton(
                                e.emojize(f"–ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –≤—ã–±—Ä–∞—Ç—å –Ω–∞—Å? :smiling_face_with_sunglasses:")),
                            types.KeyboardButton(e.emojize(f"–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å :woman_and_man_holding_hands:")),
                            types.KeyboardButton(e.emojize(f"–ü–æ–º–æ—â—å :heart_hands:")))
                        if i['tgid'] in CONFIG["admin_tg_id"]:
                            Butt_main.add(
                                types.KeyboardButton(e.emojize(f"–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å :smiling_face_with_sunglasses:")))

                        BotChecking = TeleBot(BOTAPIKEY)
                        BotChecking.send_message(i['tgid'],
                                                 texts_for_bot["ended_sub_message"],
                                                 reply_markup=Butt_main, parse_mode="HTML")

                    elif remained_time > 0 and remained_time <= 7200:
                        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
                        dbCur = conn.cursor(pymysql.cursors.DictCursor)
                        dbCur.execute(
                            f"SELECT * FROM notions where tgid=%s and notion_type='type_2hours'",
                            (i['tgid'],))
                        log = dbCur.fetchone()
                        dbCur.close()
                        conn.close()

                        if log is None:
                            conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
                            dbCur = conn.cursor(pymysql.cursors.DictCursor)
                            dbCur.execute(f"INSERT INTO notions (tgid,notion_type) values (%s,%s)",
                                          (i['tgid'], 'type_2hours',))
                            conn.commit()
                            dbCur.close()
                            conn.close()

                            Butt_reffer = types.InlineKeyboardMarkup()
                            Butt_reffer.add(
                                types.InlineKeyboardButton(
                                    e.emojize(f"–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É :money_bag:"),
                                    callback_data="PayBlock"))
                            BotChecking = TeleBot(BOTAPIKEY)
                            BotChecking.send_message(i['tgid'], texts_for_bot["alert_to_renew_sub_2hours"],
                                                     reply_markup=Butt_reffer,
                                                     parse_mode="HTML")

                    elif remained_time > 7200 and remained_time <= 86400:
                        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
                        dbCur = conn.cursor(pymysql.cursors.DictCursor)
                        dbCur.execute(
                            f"SELECT * FROM notions where tgid=%s and notion_type='type_24hours'",
                            (i['tgid'],))
                        log = dbCur.fetchone()
                        dbCur.close()
                        conn.close()

                        if log is None:
                            conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
                            dbCur = conn.cursor(pymysql.cursors.DictCursor)
                            dbCur.execute(f"INSERT INTO notions (tgid,notion_type) values (%s,%s)",
                                          (i['tgid'], 'type_24hours',))
                            conn.commit()
                            dbCur.close()
                            conn.close()

                            Butt_reffer = types.InlineKeyboardMarkup()
                            Butt_reffer.add(
                                types.InlineKeyboardButton(
                                    e.emojize(f"–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É :money_bag:"),
                                    callback_data="PayBlock"))
                            BotChecking = TeleBot(BOTAPIKEY)
                            BotChecking.send_message(i['tgid'], texts_for_bot["alert_to_renew_sub_24hours"],
                                                     reply_markup=Butt_reffer,
                                                     parse_mode="HTML")
                except ApiTelegramException as exception:
                    if (exception.description == 'Forbidden: bot was blocked by the user'):
                        conn = pymysql.connect(host=DBHOST, user=DBUSER, password=DBPASSWORD, database=DBNAME)
                        dbCur = conn.cursor(pymysql.cursors.DictCursor)
                        dbCur.execute(f"Update userss set blocked=true where tgid=%s", (i['tgid']))
                        conn.commit()
                        dbCur.close()
                        conn.close()
                    pass
        except ApiTelegramException as exception:
            print("ApiTelegramException")
            print(exception.description)
            pass
        except Exception as err:
            print('NOT AWAIT ERROR')
            print(err)
            print(traceback.format_exc())
            pass


if __name__ == '__main__':
    threadcheckTime = threading.Thread(target=checkTime, name="checkTime1")
    threadcheckTime.start()

    asyncio.run(bot.polling(non_stop=True, interval=0, request_timeout=60, timeout=60))
